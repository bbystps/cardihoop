import numpy as np
import matplotlib.pyplot as plt

# Paste your CSV here (comma-separated ADC values)
csv = """1810,1674,1750,1922,1949,1733,1728,1925,1894,1727,1775,2047,2023,1825,1665,1867,1872,1883,1790,1958,2014,1954,1813,1952,2023,1919,1835,1969,2128,2054,1794,1765,1971,1988,1919,1887,2126,2086,1957,1882,2138,2138,2064,1925,2083,2123,1971,1806,1966,2146,2160,2067,2075,2165,2085,1940,1926,2018,1904,1814,1793,1975,1982,1906,1843,1968,1870,1791,1805,2000,2007,1926,1858,1934,1967,1889,1785,1851,1990,2038,2192,2400,2707,2693,2453,2064,1858,1645,1696,1777,2018,2043,1936,1733,1778,1900,1887,1766,1776,1753,1712,1728,1793,1953,1832,1714,1570,1644,1648,1665,1714,1930,1857,1802,1759,1881,1872,1805,1785,1811,1904,2067,2113,2103,2066,2034,2198,2319,2362,2224,2194,2213,2304,2175,2146,2167,2332,2207,2174,2227,2351,2256,2242,2267,2288,2224,2146,2181,2254,2224,2177,2223,2284,2335,2215,2165,2204,2350,2303,2333,2313,2374,2274,2205,2144,2192,2197,2273,2302,2277,2128,2144,2256,2214,2166,2115,2176,2155,2162,1997,2025,2085,2181,2064,2064,2013,2096,2009,2010,1997,2122,2092,2027,1987,2032,2033,1988,2037,2111,2134,2016,2042,2058,2131,2017,2043,2070,2111,1963,2033,2091,2178,2096,2098,2066,2099,2077,2026,1990,2095,2161,2086,2096,2101,2109,1984,2046,2096,2149,2023,2092,2129,2238,2125,2115,2105,2224,2146,2105,2117,2240,2197,2101,2162,2230,2215,2101,2168,2218,2225,2043,2062,2062,2131,1980,2014,2045,2176,2060,2001,1985,2089,2033,2017,2054,2092,2064,2029,2107,2202,2287,2348,2603,2871,3088,2761,2367,2046,1953,1875,1987,2098,2223,2098,2019,2013,2091,2027,1950,1958,2007,1995,1915,1967,2002,2034,1923,1968,2000,2067,1936,1968,1983,2071,1949,1934,1971,2122,2026,1977,1983,2059,2009,1950,1971,2057,2056,1953,1970,2000,2070,1941,1991,2032,2094,1927,1950,1970,2060,1904,1891,1954,2019,1917,1872,1889,1947,1929,1855,1850,1924,1980,1840,1846,1872,1903,1797,1826,1808,1849,1763,1770,1760,1848,1762,1762,1776,1865,1827,1785,1808,1874,1866,1790,1793,1844,1904,1794,1856,1887,1941,1806,1838,1839,1951,1863,1872,1866,1936,1827,1823,1839,1905,1865,1795,1791,1803,1764,1665,1696,1744,1805,1630,1648,1651,1712,1567,1602,1629,1713,1597,1600,1623,1698,1590,1569,1583,1635,1625,1561,1584,1636,1689,1593,1599,1621,1710,1607,1646,1696,1797,1651,1657,1671,1745,1627,1616,1658,1783,1717,1639,1668,1745,1717,1625,1626,1649,1648,1547,1605,1648,1712,1599,1609,1620,1728,1612,1600,1609,1684,1629,1646,1712,1829,1815,1888,2086,2368,2623,2507,2237,1891,1674,1458,1552,1680,1829,1791,1779,1770,1812,1660,1671,1686,1744,1680,1675,1730,1785,1725,1635,1698,1766,1795,1689,1763,1842,1914,1779,1781,1806,1918,1793,1810,1850,1989,1867,1843,1866,1971,1911,1858,1882,1946,1931,1888,1899,1911,1923,1818,1885,1931,1995,1872,1854,1872,1992,1902,1918,1936,2026,1933,1914,1959,2007,1906,1862,1918,1978,1979,1895,1941,1991,2034,1922,1959,1959,2027,1935,1951,1954,2032,1936,1987,1981,2075,1939,1877,1902,1982,1937,1894,1935,1974,2007,1920,1909,1911,1963,1869,1933,1946,1994,1851,1897,1921,2018,1918,1909,1917,2009,1941,1852,1846,1975,1958,1885,1928,1936,1924,1810,1818,1840,1909,1814,1857,1874,1961,1815,1834,1809,1866,1815,1857,1902,1943,1867,1791,1840,1927,1935,1839,1861,1888,1922,1790,1806,1830,1919,1831,1834,1840,1925,1776,1715,1735,1869,1797,1726,1742,1839,1782,1665,1712,1783,1789,1662,1698,1794,1857,1712,1749,1807,1949,1931,2112,2288,2617,2525,2240,1882,1708,1535,1529,1648,1819,1843,1744,1739,1785,1811,1699,1722,1725,1764,1639,1693,1715,1763,1634,1648,1680,1767,1699,1679,1683,1737,1744,1727,1709,1733,1787,1713,1744,1817,1838,1710,1743,1771,1855,1741,1777,1804,1903,1783,1782,1776,1872,1794,1744,1776,1872,1829,1706,1723,1854,1846,1718,1712,1709,1776,1702,1737,1719,1812,1698,1709,1728,1799,1649,1669,1707,1794,1698,1642,1696,1808,1751,1616,1679,1762,1776,1648,1680,1719,1794,1680,1716,1713,1859,1751,1756,1745,1815,1751,1789,1792,1907,1859,1808,1821,1858,1859,1751,1805,1828,1844,1751,1792,1808,1887,1759,1766,1808,1934,1842,1861,1806,1872,1810,1785,1838,1936,1861,1783,1847,1918,1928,1826,1863,1923,2000,1923,1938,1968,2064,1947,1962,1958,2001,1904,1906,1930,1990,1939,1894,1898,1924,1907,1809,1846,1903,1936,1828,1853,1865,1930,1869,1926,1924,1959,1850,1924,1947,2010,1907,1898,2032,2234,2351,2501,2747,2815,2505,2056,1803,1745,1891,1887,2030,2100,2209,2032,2003,1974,2057,1919,1925,1955,2070,1968,1930,1933,1972,1941,1989,2026,2078,2083,1939,1951,1950,1987,1895,1929,1935,2037,1929,1936,1941,2042,1984,2009,2022,2113,2064,1993,1974,2061,2034,1952,1989,2032,2021,1904,1939,1958,2017,1916,1953,1962,2004,1919,1975,2005,2079,1977,1998,2000,2005,1927,1866,1904,1975,2003,1891,1887,1913,1928,1782,1852,1921,1959,1872,1901,1898,1986,1875,1866,1847,1973,1920,1877,1904,1990,1970,1919,1936,1938,1947,1903,1951,1958,2001,1872,1923,1943,2037,1922,1953,1977,2063,1921,1898,1920,2030,1993,1863,1888,1955,1999,1905,1911,1933,1950,1829,1883,1915,1998,1879,1925,1993,2102,1975,1946,1947,2064,1970,1944,1969,2091,2012,1903,1904,1959,1961,1838,1854,1910,1979,1851,1849,1863,1971,1872,1872,1869,1914,1781,1854,1904,1963,1903,1885,1917,2032,2091,2161,2386,2704,2864,2576,2210,1886,1767,1666,1776,1879,2026,1936,1964,1994,2047,1904,1891,1904,1968,1920,1889,1911,1968,1928,1840,1891,1941,1984,1906,1931,1933,2019,1888,1955,1945,2042,1968,1955,1958,2054,1970,1984,2034,2127,2065,1984,1995,2091,2074,1986,1982,2000,2112,1968,1925,2005,2096,1972,1981,2006,2067,1930,1936,1949,2010,1905,1922,1968,2035,2005,1922,1941,1997,1989,1901,1937,1974,2042,1920,1919,1911,1996,1881,1920,1910,1991,1893,1873,1911,2027,1981,1925,1957,2039,1984,1909,1966,1995,2043,1967,1979,1955,1993,1879,1970,1983,2025,1907,1935,1938,2083,1982,1948,1968,2061,2011,1983,1978,2003,1968,1878,1946,1999,1995,1872,1946,2013,2115,2016,2038,2032,2139,1995,1998,1987,2065,1968,1937,1989,2061,2000,2000,2035,2045,1987,1871,1869,1883,1963,1826,1833,1821,1925,1824,1839,1839,1910,1807,1808,1872,1939,1885,1860,1883,2032,2127,2174,2400,2676,2823,2526,2176,1862,1744,1578,1680,1825,2010,1904,1847,1778,1887,1823,1808,1819,1890,1840,1773,1797,1863,1859,1746,1799,1867,1926,1822,1843,1819,1881,1810,1856,1831,1901,1801,1814,1842,1923,1856,1843,1889,1998,1965,1869,1906,1940,1947,1862,1933,1929,1946,1861,1897,1877,1962,1857,1849,1873,1967,1874,1823,1817,1878,1797,1734,1776,1869,1872,1779,1785,1856,1914,1809,1840,1845,1931,1807,1829,1847,1955,1818,1839,1863,1954,1841,1815,1884,1963,1909,1878,1927,1963,1936,1830,1872,1918,1962,1874,1920,1925,1987,1840,1838,1806,1937,1855,1856,1869,1953,1865,1808,1818,1917,1917,1821,1845,1904,1939,1817,1830,1836,1857,1769,1830,1819,1992,1917,1856,1835,1936,1875,1889,1920,2043,1914,1851,1870,1936,2001,1947,1923,1915,1910,1792,1840,1872,1911,1767,1752,1751,1878,1783,1750,1765,1849,1729,1687,1751,1881,1851,1777,1771,1827,1847,1785,1867,1982,2177,2269,2554,2742,2688,2130,1798,1617,1660,1591,1720,1823,1929,1845,1803,1806,1841,1840,1783,1783,1769,1781,1751,1849,1877,1894,1753,1765,1793,1893,1791,1819,1854,1966,1869,1845,1829,1900,1886,1845,1856,1910,1936,1855,1898,1923,1965,1888,1914,1904,1953,1858,1930,1906,1969,1873,1865,1863,1945,1872,1838,1840,1919,1899,1870,1885,1917,1898,1808,1854,1894,1963,1856,1871,1871,1978,1899,1925,1926,2010,1933,1929,1943,2047,1983,1975,1999,2037,2068,2007,2034,2045,2117,1991,2025,2062,2146,2029,2036,2035,2111,1984,1995,2003,2128,2064,2001,2021,2081,1997,1899,1968,2066,1997,1879,1936,1994,2074,1920,1997,2013,2075,1935,1939,1950,2046,1947,1953,1989,2107,2032,1968,2018,2112,2114,2002,1990,2032,2064,1995,2002,2006,2031,1911,1995,1967,2002,1847,1809,1823,1921,1831,1811,1819,1925,1929,1886,1869,1897,1899,1837,1871,1935,2021,1954,2031,2175,2399,2467,2722,2889,2784,2219,1836,1641,1714,1712,1830,1925,2001,1943,1892,1904,1954,1958,1843,1871,1933,2003,1927,1922,1934,2056,1950,1975,1980,2032,1926,1926,1959,2097,2047,1985,1986,2032,1991,1946,2027,2096,2128,1994,2053,2096,2126,2001,2075,2074,2151,2010,2035,2027,2109,1981,1953,1980,2097,2059,1953,1918,1951,1920,1840,1910,1951,1965,1837,1851,1879,1950,1829,1858,1860,1987,1857,1842,1843,1936,1886,1835,1824,1906,1930,1863,1855,1936,1929,1802,1840,1873,1931,1835,1865,1867,1955,1875,1862,1839,1932,1824,1813,1825,1962,1867,1815,1818,1902,1889,1826,1854,1903,1879,1745,1821,1923,1979,1859,1882,1865,1923,1795,1809,1824,1901,1813,1813,1823,1922,1838,1763,1776,1833,1860,1811,1872,1885,1931,1847,1903,1907,2001,1935,1904,1894,1969,1850,1842,1873,1961,1830,1783,1794,1878,1803,1698,1719,1782,1805,1686,1690,1711,1763,1742,1728,1733,1846,1727,1738,1755,1871,1779,1808,1917,2192,2352,2576,2815,2843,2434,1926,1697,1612,1669,1691,1827,1856,1908,1744,1811,1822,1887,1712,1674,1673,1776,1701,1668,1653,1745,1733,1668,1680,1732,1723,1621,1653,1666,1728,1642,1679,1703,1802,1664,1663,1666,1775,1651,1664,1677,1762,1686,1663,1685,1734,1703,1613,1641,1703,1713,1575,1582,1686,1733,1552,1573,1563,1623,1481,1471,1520,1634,1477,1490,1514,1609,1582,1519,1520,1642,1625,1530,1553,1581,1577,1447,1442,1520,1602,1487,1497,1519,1648,1517,1472,1472,1611,1531,1492,1470,1535,1478,1414,1451,1521,1520,1426,1439,1475,1585,1458,1468,1481,1558,1502,1552,1503,1557,1473,1488,1509,1597,1482,1426,1467,1545,1523,1454,1491,1551,1535,1422,1467,1511,1584,1456,1516,1517,1597,1474,1502,1549,1611,1505,1491,1518,1631,1578,1501,1530,1670,1683,1585,1590,1712,1765,1648,1680,1680,1729,1571,1589,1616,1692,1584,1616,1628,1685,1563,1534,1525,1567,1474,1410,1422,1553,1606,1469,1442,1469,1521,1427,1439,1397,1502,1445,1472,1504,1646,1663,1771,1935,2288,2545,2690,2455,2041,1635,1344,1347,1503,1627,1584,1587,1521,1521,1456,1477,1445,1517,1392,1425,1505,1589,1450,1402,1409,1535,1489,1404,1441,1568,1559,1488,1519,1563,1602,1488,1552,1583,1692,1598,1609,1607,1705,1579,1554,1591,1707,1643,1637,1668,1759,1696,1570,1657,1758,1713,1563,1601,1645,1697,1587,1583,1566,1680,1579,1611,1609,1735,1626,1600,1584,1655,1648,1630,1648,1694,1681,1626,1679,1728,1709,1642,1698,1729,1835,1710,1687,1723,1824,1702,1727,1730,1799,1759,1763,1786,1840,1776,1745,1808,1840,1814,1735,1813,1874,1882,1740,1781,1828,1905,1776,1791,1819,1959,1842,1777,1805,1952,1839,1776,1838,1942,1896,1799,1824,1895,1937,1822,1840,1846,1919,1853,1905,1872,1973,1923,1935,1899,1993,1901,1883,1883,1984,1953,1930,1929,1967,1922,1868,1906,1926,1895,1847,1905,1911,1966,1843,1873,1912,2043,1979,1975,1949,2061,1970,1971,2015,2082,2055,1968,1990,2088,2122,2031,2043,2063,2082,1958,1975,1999,2064,1924,1962,1968,2091,1953,1968,2022,2095,2000,1968,1983,2032,2074,2023,2067,2150,2233,2298,2557,2834,3179,3028,2661,2233,2068,1872,1931,1997,2087,1969,1937,1892,1945,1905,1881,1918,1984,1936,1841,1922,1971,2021,1904,1935,1957,2037,1911,1949,2000,2133,2022,2016,1983,2103,2064,2037,2004,2064,2096,2071,2081,2115,2109,2003,2039,2078,2134,2017,2064,2045,2119,2021,2042,2010,2111,2032,2058,2032,2095,2011,1955,1947,2043,2061,1961,1983,2038,2047,1981,2009,2027,2092,1994,2034,2067,2233,2090,2071,2066,2181,2126,2099,2081,2145,2085,2047,2075,2146,2202,2114,2111,2096,2125,2027,2104,2126,2174,2020,2038,2030,2159,2064,2045,2055,2160,2086,2030,2075,2176,2128,2047,2062,2131,2155,2057,2096,2139,2177,2039,2091,2078,2166,2055,2086,2120,2223,2128,2127,2134,2192,2113,2040,2079,2173,2157,2070,2066,2087,2112,2022,2064,2027,2090,1970,1999,2001,2099,1980,1997,2035,2139,2062,2015,2027,2186,2153,2064,2067,2131,2167,2092,2139,2167,2224,2145,2154,2166,2243,2152,2199,2186,2256,2169,2162,2135,2245,2176,2124,2123,2185,2155,2070,2038,2083,2135,2016,2075,2128,2197,2093,2099,2065,2135,2065,2087,2096,2204,2096,2095,2154,2300,2334,2469,2725,3053,3152,2825,2443,2191,2078,1985,2090,2190,2322,2181,2170,2139,2212,2094,2098,2153,2256,2137,2078,2077,2139,2112,2096,2172,2190,2149,2046,2093,2160,2254,2110,2103,2101,2170,2064,2112,2131,2246,2122,2107,2139,2239,2175,2159,2157,2231,2206,2117,2148,2191,2227,2095,2123,2127,2167,2039,2075,2086,2190,2078,2075,2059,2135,2060,2047,2047,2129,2101,2064,2110,2166,2152,2096,2115,2113,2128,2002,2062,2106,2187,2060,2033,2009,2115,2025,2071,2131,2194,2128,2107,2128,2171,2075,2054,2093,2130,2149,2001,2027,2080,2117,2001,2029,2029,2162,2055,2064,2031,2155,2011,2002,2043,2179,2118,2059,2063,2097,2063,1974,1985,2033,2086,1984,2017,2017,2086,1968,1961,1942,2087,1963,1923,1906,2082,2023,2022,2001,2038,1985,1943,1959,2023,2037,1939,1947,1985,2033,1905,1927,1936,1983,1843,1823,1887,2045,1965,1903,1887,1999,1974,1999,2047,2110,2131,2082,2099,2135,2147,2062,2100,2136,2244,2121,2142,2121,2238,2115,2111,2069,2141,2057,2078,2064,2097,2016,1949,1946,2000,1949,1849,1875,1906,1941,1827,1840,1859,1949,1847,1875,1955,2142,2160,2367,2640,2833,2522,2101,1782,1783,1822,1882,1996,2028,1965,1850,1859,1881,1952,1814,1813,1808,1950,1852,1835,1793,1873,1812,1856,1846,1904,1834,1789,1834,1905,1897,1794,1838,1927,1946,1840,1871,1904,1979,1872,1878,1899,1978,1890,1905,1930
"""
signal = np.array([int(x) for x in csv.split(",") if x.strip() != ""])

FS = 250  # Hz (match your ESP32 sampling rate)

# -------------------------
# Noise filtering / Preprocess
# -------------------------
def high_pass_1st(x, alpha=0.995):
    # y[n] = alpha * (y[n-1] + x[n] - x[n-1])
    y = np.zeros_like(x, dtype=np.float32)
    y_prev = 0.0
    x_prev = x[0]
    for i in range(1, len(x)):
        y_prev = alpha * (y_prev + x[i] - x_prev)
        y[i] = y_prev
        x_prev = x[i]
    return y

def moving_average(x, win=5):
    win = int(win)
    if win <= 1:
        return x
    k = np.ones(win, dtype=np.float32) / win
    return np.convolve(x, k, mode="same")

x = signal.astype(np.float32)

# 1) remove DC offset
x0 = x - np.mean(x)

# 2) baseline wander removal (high-pass)
hp = high_pass_1st(x0, alpha=0.995)

# 3) light smoothing (low-pass-ish)
sm = moving_average(hp, win=5)

# 4) normalize
mx = np.max(np.abs(sm)) + 1e-6
ecg = sm / mx  # final preprocessed ECG

# -------------------------
# R-peak detection (simple, practical)
# -------------------------
def detect_r_peaks(ecg_norm, fs=250):
    ecg_norm = ecg_norm.astype(np.float32)

    # Emphasize peaks
    y = ecg_norm * ecg_norm  # square

    # Smooth envelope (~120 ms)
    env = moving_average(y, int(0.12 * fs))

    # Adaptive threshold
    thr = np.mean(env) + 1.5 * np.std(env)

    # Refractory period (~250 ms)
    refractory = int(0.25 * fs)
    peaks = []
    last = -refractory

    for i in range(1, len(env) - 1):
        if i - last < refractory:
            continue
        if env[i] > thr and env[i] > env[i - 1] and env[i] >= env[i + 1]:
            # refine peak location in original ecg around i (Â±80 ms)
            w = int(0.08 * fs)
            a = max(0, i - w)
            b = min(len(ecg_norm), i + w)
            r = a + int(np.argmax(ecg_norm[a:b]))
            peaks.append(r)
            last = r

    return np.array(peaks, dtype=int), env, thr

r_idx, env, thr = detect_r_peaks(ecg, fs=FS)

# BPM estimate
if len(r_idx) >= 2:
    rr = np.diff(r_idx) / FS
    bpm = 60.0 / np.mean(rr)
else:
    rr = np.array([])
    bpm = float("nan")

# -------------------------
# Final graph (1 figure)
# -------------------------
t = np.arange(len(ecg)) / FS

plt.figure()
plt.plot(t, ecg, linewidth=0.9)
if len(r_idx) > 0:
    plt.scatter(t[r_idx], ecg[r_idx], s=25)

plt.title(f"Preprocessed ECG + R-peaks (BPM ~ {bpm:.1f})")
plt.xlabel("Time (s)")
plt.ylabel("Normalized amplitude")
plt.ylim(-1.2, 1.2)
plt.grid(True, alpha=0.3)
plt.show()

# Optional: print debug info
print(f"Samples: {len(ecg)}  R-peaks: {len(r_idx)}  BPM: {bpm:.2f}")
